<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPMS AI助理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 样式保持不变，与原始代码相同 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* 新增全局视口适配 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;  /* 修改此处 */
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            margin: 0;  /* 新增清除默认外边距 */
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #eaecef;
            background: white;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .clear-btn {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fafafa;
            width: 100%;  /* 新增 */
        }

        .message {
            margin-bottom: 24px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-time {
            font-size: 12px;
            color: #95a5a6;
            margin-bottom: 8px;
        }

        .user-message {
            margin-left: auto;
        }

        .user-content {
            background-color: #3498db;
            color: white;
            padding: 12px 16px;
            border-radius: 18px 18px 6px 18px;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }

        .ai-message {
            margin-right: auto;
        }

        .ai-content {
            background-color: white;
            color: #2c3e50;
            padding: 12px 16px;
            border-radius: 18px 18px 18px 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #eaecef;
        }

        .generating {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 10px;
        }

        .stop-generate {
            color: #3498db;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .stop-generate:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #3498db;
            color: #3498db;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }

        .dot-flashing:before, .dot-flashing:after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }

        .dot-flashing:before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #3498db;
            color: #3498db;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }

        .dot-flashing:after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #3498db;
            color: #3498db;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }

        @keyframes dotFlashing {
            0% {
                background-color: #3498db;
            }
            50%, 100% {
                background-color: rgba(52, 152, 219, 0.2);
            }
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #eaecef;
            background: white;
            width: 100%;  /* 新增 */
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8f9fa;
            border-radius: 24px;
            padding: 8px 20px;
            border: 1px solid #eaecef;
            transition: border-color 0.3s;
        }

        .chat-input-wrapper:focus-within {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            font-size: 16px;
            color: #2c3e50;
            outline: none;
        }

        .chat-input::placeholder {
            color: #95a5a6;
        }

        .send-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .send-btn:disabled {
            color: #95a5a6;
            cursor: not-allowed;
        }

        .send-btn:disabled:hover {
            background-color: transparent;
        }

        .tools-panel {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tool-btn {
            background-color: white;
            border: 1px solid #eaecef;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 14px;
            color: #7f8c8d;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .tool-btn:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }

        .mcp-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #95a5a6;
            margin-top: 8px;
        }

        .mcp-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #2ecc71;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #95a5a6;
            margin-top: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #95a5a6;
        }

        .status-dot.connected {
            background-color: #2ecc71;
        }

        .status-dot.error {
            background-color: #e74c3c;
        }


        .event-log {
            background-color: #f8f9fa;
            border: 1px solid #eaecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #7f8c8d;
            max-height: 100px;
            overflow-y: auto;
        }

        .event-item {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eaecef;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                width: 100%;
            }

            .message {
                max-width: 90%;
            }

            .chat-input-wrapper {
                padding: 6px 16px;
            }

            .chat-input {
                font-size: 14px;
            }

            .chat-header {
                padding: 16px;
            }

            .chat-messages {
                padding: 16px;
            }

            .chat-input-container {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
<div class="chat-container">
    <!-- 聊天头部 -->
    <div class="chat-header">
        <div class="header-left">
            <div class="logo">
                <i class="fas fa-robot"></i>
            </div>
            <div class="header-title">业务场景测试</div>
        </div>
        <button class="clear-btn" id="clear-btn">
            <i class="fas fa-broom"></i> 清空对话
        </button>
    </div>

    <!-- 聊天消息区域 -->
    <div class="chat-messages" id="chat-messages">
        <div class="message ai-message">
            <div class="message-time" id="welcome-time"></div>
            <div class="ai-content">
                <p>您好！我是TPMS AI助理，支持流式响应。请问有什么可以帮您？</p>
            </div>
        </div>
    </div>

    <!-- 聊天输入区域 -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <input type="text" class="chat-input" id="chat-input" placeholder="请输入您的问题或需求，按回车发送">
            <button class="send-btn" id="send-btn" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

        <div class="tools-panel">
            <button class="tool-btn">
                <i class="fas fa-code"></i> 工单查询
            </button>
            <button class="tool-btn">
                <i class="fas fa-database"></i> 业务查询
            </button>
            <button class="tool-btn">
                <i class="fas fa-search"></i> 知识库搜索
            </button>
        </div>

        <div class="mcp-indicator">
            <div class="mcp-dot"></div>
            <span>MCP工具服务已连接</span>
        </div>

    </div>
</div>

<script>
    // 设置欢迎消息的时间为当前时间
    document.getElementById('welcome-time').textContent = new Date().toLocaleString('zh-CN');
    var ctx = window.parent.dwf_ctx;
    var knowledgeId;
    ctx.handleQueryData(
        {
            "targetClass": "Scenario",
            "query": { query: `and obj.oid='${ctx.obj.scenarioId}'` }
        }).then(res => {
        debugger
        if (res != undefined && res.length > 0) {
            knowledgeId = res[0].knowledgeId;
        }
    })
    // 固定参数配置
    const agentConfig = {
        "id": "xxxx",
        "name": "LightRagAgent",
        "description": "Agent for lightrag tasks",
        "knowledge_type": "aperag",
        "knowledge_filters": {
            "collection_id": knowledgeId
        },
        "chat_model_config": {
            "service_provider": "openailike",
            "id": "Qwen/Qwen2.5-7B-Instruct",
            "api_key": "20676974-d271-4004-bf7d-472627477901",
            "base_url": "https://api-inference.modelscope.cn/v1/",
            "temperature": 0.7,
            "max_tokens": 8192
        },
        "tools": [
            {
                "type": "func",
                "module_name": "agno.tools.duckduckgo",
                "class_name": "DuckDuckGoTools",
                "params": {
                    "enable_search": true,
                    "enable_news": true,
                    "all": true,
                    "modifier": "",
                    "fixed_max_results": "",
                    "proxy": "",
                    "timeout": 10,
                    "verify_ssl": true
                }
            }
        ],
        "prompts": {
            "default": {
                "system": "你具备专业的印刷知识，能够根据客户需求提供准确、详细的报价计算。\n",
                "introduction": "1. 查询知识库，搜索相关的数据\n2. 从网络搜索，调用DuckDuckGoTools"
            }
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const clearBtn = document.getElementById('clear-btn');
        const sendBtn = document.getElementById('send-btn');

        let currentAbortController = null;
        let currentAIResponseElement = null;
        let isGenerating = false;

        // 简化的事件日志 - 只输出到控制台
        function addEventLog(message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN');
            console.log(`[${timeString}] ${message}`);
        }

        // 滚动到聊天底部
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 添加用户消息
        function addUserMessage(message) {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const messageHtml = `
                <div class="message user-message">
                    <div class="message-time">${timeString}</div>
                    <div class="user-content">
                        <p>${message}</p>
                    </div>
                </div>
            `;

            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
            addEventLog(`用户消息: ${message}`);
        }

        // 添加AI消息
        function addAIMessage(message = '', showGenerating = false) {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            let generatingHtml = '';
            if (showGenerating) {
                generatingHtml = `
                    <div class="generating">
                        <div class="dot-flashing"></div>
                        <span>正在生成...</span>
                        <button class="stop-generate">停止生成</button>
                    </div>
                `;
            }

            const messageHtml = `
                <div class="message ai-message">
                    <div class="message-time">${timeString}</div>
                    <div class="ai-content">
                        <p>${message}</p>
                        ${generatingHtml}
                    </div>
                </div>
            `;

            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();

            // 获取新添加的AI消息元素
            currentAIResponseElement = chatMessages.querySelector('.message:last-child .ai-content p');

            // 为新添加的停止生成按钮添加事件监听
            if (showGenerating) {
                const newStopBtn = chatMessages.querySelector('.message:last-child .stop-generate');
                if (newStopBtn) {
                    newStopBtn.addEventListener('click', stopGeneration);
                }
            }

            return currentAIResponseElement;
        }

        // 移除生成状态指示器
        function removeGeneratingIndicator() {
            const generatingElements = document.querySelectorAll('.generating');
            generatingElements.forEach(element => {
                element.remove();
            });
            isGenerating = false;
        }

        // 停止生成处理
        function stopGeneration() {
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;

                // 更新UI显示生成已停止
                const generatingElements = document.querySelectorAll('.generating');
                generatingElements.forEach(element => {
                    element.innerHTML = '<span>生成已停止</span>';
                });

                // 设置定时器，2秒后移除生成指示器
                setTimeout(removeGeneratingIndicator, 2000);

                addEventLog('用户停止了生成');
            }
        }

        // 清空聊天记录
        function clearChat() {
            const firstAIMessage = chatMessages.querySelector('.message:first-child');
            chatMessages.innerHTML = '';
            if (firstAIMessage) {
                chatMessages.appendChild(firstAIMessage);
            }
            scrollToBottom();
            addEventLog('用户清空了对话');
        }

        // 处理多行SSE数据格式
        function processMultiLineSSE(buffer) {
            const events = [];
            let currentEvent = null;
            let jsonBuffer = '';
            let inEvent = false;
            let braceCount = 0;

            const lines = buffer.split('\n');

            for (const line of lines) {
                if (line.trim() === '') continue;

                // 检查是否是事件开始
                if (line.startsWith('data: {')) {
                    inEvent = true;
                    jsonBuffer = '{';
                    braceCount = 1; // 开始大括号
                    continue;
                }

                // 如果是事件数据行
                if (inEvent && line.startsWith('data: ')) {
                    // 去掉"data: "前缀并清理行
                    let dataLine = line.substring(6).trim();

                    // 计算大括号数量来检测完整的JSON对象
                    for (let char of dataLine) {
                        if (char === '{') braceCount++;
                        if (char === '}') braceCount--;
                    }

                    jsonBuffer += dataLine;

                    // 如果大括号数量为0，说明JSON对象完整
                    if (braceCount === 0) {
                        inEvent = false;

                        // 尝试解析完整的JSON
                        try {
                            const eventData = JSON.parse(jsonBuffer);
                            events.push(eventData);
                        } catch (e) {
                            console.error('解析JSON失败:', e, '内容:', jsonBuffer);
                            // 如果解析失败，尝试修复常见的JSON格式问题
                            try {
                                const fixedJson = fixJsonFormat(jsonBuffer);
                                const eventData = JSON.parse(fixedJson);
                                events.push(eventData);
                            } catch (e2) {
                                console.error('修复后解析仍然失败:', e2);
                            }
                        }
                        jsonBuffer = '';
                        braceCount = 0;
                    }
                }
            }

            return events;
        }

        function fixJsonFormat(jsonStr) {
            // 移除可能的尾随逗号
            let fixed = jsonStr.replace(/,\s*([}\]])/g, '$1');

            // 修复未转义的控制字符
            fixed = fixed.replace(/[\x00-\x1F\x7F]/g, '');

            // 修复未闭合的字符串
            fixed = fixed.replace(/"([^"\\]*(\\.[^"\\]*)*)"?/g, (match) => {
                if (!match.endsWith('"')) {
                    return match + '"';
                }
                return match;
            });

            return fixed;
        }

        // 解码Unicode转义序列
        function decodeUnicode(str) {
            try {
                return str.replace(/\\u([\dA-F]{4})/gi,
                    (match, grp) => String.fromCharCode(parseInt(grp, 16)));
            } catch (e) {
                console.error('解码Unicode失败:', e);
                return str; // 如果解码失败，返回原始字符串
            }
        }

        // 发送消息到SSE接口
        async function sendMessageToSSE(message) {
            // 关闭现有的连接（如果有）
            if (currentAbortController) {
                currentAbortController.abort();
            }

            // 创建新的AbortController
            currentAbortController = new AbortController();
            isGenerating = true;

            // 准备请求数据
            const requestData = {
                message: message,
                stream: true,
                agent_config: agentConfig
            };

            addEventLog('开始连接到服务器');

            try {
                const response = await fetch('http://192.168.30.9:7777/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'bearer sk-84362eec89484c13aadd34de7a7834aa'
                    },
                    body: JSON.stringify(requestData),
                    signal: currentAbortController.signal
                });

                if (!response.ok) {
                    throw new Error(`服务器错误: ${response.status} ${response.statusText}`);
                }

                addEventLog('连接成功，开始接收数据');

                // 读取流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let partialBuffer = ''; // 用于处理不完整的数据

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        addEventLog('流式响应结束');
                        // 处理剩余的数据
                        if (partialBuffer.trim()) {
                            try {
                                const remainingEvents = processMultiLineSSE(partialBuffer);
                                processEvents(remainingEvents);
                            } catch (e) {
                                console.error('处理剩余数据时出错:', e);
                            }
                        }
                        break;
                    }

                    // 解码数据并添加到缓冲区
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;

                    // 查找完整的事件分隔符（两个换行符）
                    const eventSeparator = '\n\n';
                    let separatorIndex = buffer.indexOf(eventSeparator);

                    while (separatorIndex !== -1) {
                        // 提取完整的事件
                        const completeEvent = buffer.substring(0, separatorIndex);
                        buffer = buffer.substring(separatorIndex + eventSeparator.length);

                        // 处理完整的事件
                        if (completeEvent.trim()) {
                            try {
                                const events = processMultiLineSSE(completeEvent + eventSeparator);
                                processEvents(events);
                            } catch (e) {
                                console.error('处理事件时出错:', e);
                                // 如果处理失败，将数据添加到部分缓冲区稍后重试
                                partialBuffer += completeEvent;
                            }
                        }

                        separatorIndex = buffer.indexOf(eventSeparator);
                    }

                    // 处理缓冲区中剩余的不完整数据
                    if (buffer.trim() && buffer.indexOf(eventSeparator) === -1) {
                        partialBuffer += buffer;
                        buffer = '';
                    }
                }

                // 如果循环正常结束，也移除生成指示器
                removeGeneratingIndicator();

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('请求已被中止');
                    addEventLog('请求已被用户中止');
                } else {
                    console.error('请求错误:', error);
                    if (currentAIResponseElement) {
                        currentAIResponseElement.textContent += `\n\n错误: ${error.message}`;
                    }
                    addEventLog(`请求错误: ${error.message}`);

                    // 移除生成中的提示
                    removeGeneratingIndicator();
                }
            } finally {
                currentAbortController = null;
                isGenerating = false;
            }
        }

        function processEvents(events) {
            for (const event of events) {
                console.log('处理事件:', event);

                if (event.event === "RunContent" && event.content) {
                    // 解码Unicode转义序列
                    let content = decodeUnicode(event.content);

                    // 逐步更新AI消息内容
                    if (currentAIResponseElement) {
                        currentAIResponseElement.textContent += content;
                        scrollToBottom();
                    }

                    addEventLog(`收到内容: ${content}`);
                } else if (event.event === "RunCompleted") {
                    // 响应完成
                    addEventLog('响应完成');

                    // 移除生成中的提示
                    removeGeneratingIndicator();
                } else if (event.event === "RunStarted") {
                    addEventLog('会话开始');
                } else if (event.event === "ToolCallCompleted") {
                    addEventLog(`工具调用完成: ${event.content}`);
                } else if (event.event === "ToolCallStarted") {
                    addEventLog(`工具调用开始: ${event.tool?.tool_name}`);
                }
            }
        }
        // 事件监听
        chatInput.addEventListener('input', function() {
            sendBtn.disabled = this.value.trim() === '' || isGenerating;
        });

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim() !== '' && !isGenerating) {
                sendBtn.click();
            }
        });

        sendBtn.addEventListener('click', function() {
            if (chatInput.value.trim() !== '' && !isGenerating) {
                const message = chatInput.value.trim();
                addUserMessage(message);

                // 添加AI消息并开始生成
                addAIMessage('', true);

                // 发送消息到SSE接口
                sendMessageToSSE(message);

                chatInput.value = '';
                sendBtn.disabled = true;
            }
        });

        clearBtn.addEventListener('click', clearChat);

        // 初始滚动到底部
        scrollToBottom();
    });
</script>
</body>
</html>



